<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="https://polygit.org/polymer+v2.0.0/shadycss+webcomponents+1.0.0/components/iron-ajax/iron-ajax.html">

<dom-module id="patient-demographics">

  <template>

    <style>

      :host {
        width: 100%;
        color: var(--patient-demographics-font-color , rgb(255, 255, 255));
      }

      :host #content {
        padding: 10px;
      }

      :host #name {
        text-align: center;
        font-size: var(--patient-demographics-font-size-name , 32pt);
      }

      :host #maleAge {
        font-size: var(--patient-demographics-font-size-male-age , 24pt);
        margin-left: 15px;
      }

      :host #birthdate {
        font-size: var(--patient-demographics-font-size-birthdate , 24pt);
      }

      :host #birthdateTitle {
        font-weight: 900;
        font-size: var(--patient-demographics-font-size-birthdate-title , 24pt);
      }

    </style>


  <div id=content>
    <div id="name">
      <template is="dom-repeat" items="[[patient.name.0.given]]">
        {{item}}
      </template> {{patient.name.0.family}}
  </div>
  </br>
  <div id="maleAge">
    {{patient.gender}}, {{age}}
  </div>
  </br>
  <div id="birthdate">
    <div id="birthdateTitle">Date of birth:</div>
    {{patient.birthDate}}
  </div>
  </div>
  <iron-ajax url="{{url}}" params='{"_format":"application/fhir+json"}' content-type="application/json" handle-as="json" on-response="handleResponse" method="GET" on-error="_error" id="iron_ajax"></iron-ajax>


  </template>

  <script>
    class PatientDemographics extends Polymer.Element {
      static get is() {
        return 'patient-demographics';
      }
      static get properties() {
        return {
          patient: {
            type: Object
          },
          uuid: {
            type: String,
            observer: "_changedUUID"
          },
          url: {
            type: String
          },
          age: {
            type: Number
          }
        }
      }
      constructor() {
        super();
      }

      handleResponse(data) {
        var tmp_patient = data.detail.response;
        console.log(tmp_patient);
        tmp_patient.gender = __capitalizeFirstLetter(tmp_patient.gender);
        this.patient = tmp_patient
        this.age = __getAge(this.patient.birthDate);
      }

      _error(event) {
        console.log(event);
        console.log(event.detail);
        console.log(event.detail.error);
        console.log(event.detail.error.message);
        console.log(event.detail.request);
        console.log(event.detail.response);
        console.log(event.detail.request.response);
      }

      _changedUUID() {
        this.url = "http://test.fhir.org/r3/Patient/" + this.uuid;
        this.$.iron_ajax.generateRequest();
      }

    }
    customElements.define(PatientDemographics.is, PatientDemographics);
  </script>

  <script>
    function __getAge(birthdate) {
      return 21;
    }

    //part of code from https://stackoverflow.com/questions/1026069/how-do-i-make-the-first-letter-of-a-string-uppercase-in-javascript
    function __capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
  </script>

</dom-module>
